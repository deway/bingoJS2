<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
</head>
<body>
    test start
    <script type="text/html" id="tmpl1">
        {{view controller="user/list"}}
            <div style="color:red;font-size:[test+'asdfa'];asdfa:[user]" aaaaa="[aaa]"></div>
        <input type="text" value="[user.name]" />

        {{text user.desc /}}
        {{print user.desc /}}

            <div onclick="[user.click('asdf')]"></div>
        <div onclick='[user.aaaa("")]'></div>
            {{if user.enabled}}
                {{if user.role == 'admin'}}
        asdfsdfddd
                {{/if}}
            {{else}}
                else1
            {{else}}!
                test else
            !{{/if}}
        {{/view}}
        {{user}}
          test
        {{/user}}
        {{if test}}
            if
        {{/if}}
        {{view /}}
        {{view controller="user/form" /}}
    </script>
    <script type="text/html" id="tmpl2"><div t="asdf" aaa="test('a\'sdfas[user.name]df')" bbb='atest[user.name]'></div></script>
    <script src="../scripts/bingo2/bingo.js"></script>
    <script src="compiles.js"></script>
    <script type="text/javascript">

        //tran command
        (function () {
            var tmpl = document.getElementById('tmpl1').innerHTML;


            //指令解释:
            //{{cmd /}}
            //{{cmd attr="asdf" /}}
            //{{cmd attr="asdf"}} content {{/cmd}}
            var _commandEx = /\{\{\s*(\S+)\s*(.*?)\/\}\}|\{\{\s*(\S+)\s*?(.*?)\}\}((?:.|\n|\r)*)\{\{\/\3\}\}/gi;
            var _checkElse = /\{\{\s*(\/?if|else)\s*(.*?)\}\}/gi;
            var _scriptTag = '<' + 'script type="text/html"></' + 'script>';

            var _traverseCmd = function (tmpl) {
                _commandEx.lastIndex = 0;
                var list = [];
                tmpl.replace(_commandEx, function (find, cmd, attrs, cmd1, attrs1, content1) {
                    //console.log('_commandEx', arguments);
                    if (cmd1 == 'if')
                        _traverseElse(content1);
                    list.push(cmd ? {
                        cmd: cmd,
                        attrs: attrs,
                        content: '',
                        children: []
                    } : {
                        cmd: cmd1,
                        attrs: attrs1,
                        content: content1,
                        children: _traverseCmd(content1)
                    });
                    return find;
                });
                return list;
            }, _traverseElse = function (content) {
                var lv = 0, item, cmd, index =-1;
                _checkElse.lastIndex = 0;
                console.log('else content', content);
                var elseList = [];
                while (item = _checkElse.exec(content)) {
                    (lv < 0) && (lv = 0);
                    cmd = item[1]
                    if (cmd == 'if')
                        lv++;
                    else {
                        lv--;
                        if (lv < 0) {
                            if (index >= 0) {
                                elseList.push(content.substr(index, item.index - index));
                            }
                            //查找到位置加查找的长度
                            index = item.index + item[0].length;
                        }

                        console.log('checkElse', lv, cmd, index);
                    }
                }
                if (lv < 0)
                    elseList.push(content.substr(index));
                console.log('elseList', elseList);
            };
            var cmdList = _traverseCmd(tmpl);
            console.log('cmdList', cmdList);


            //查找dom 节点 <div>
            var _domNodeReg = /\<[^>]+\>/gi,
                //解释可绑定的节点属性: attr="fasdf[user.name]"
                _domAttrReg = /(\S+)\s*=\s*(\"(?:\\\"|[^"])*?\[.+?\](?:\\\"|[^"])*\"|\'(?:\\\'|[^'])*?\[.+?\](?:\\\'|[^'])*\')/gi;

            var _domAttrList = [];
            var s = tmpl.replace(_domNodeReg, function (find, pos, content) {
                //console.log('domNodeReg', arguments);
                _domAttrReg.lastIndex = 0;
                return find.replace(_domAttrReg, function (findAttr, name, dot, content) {
                    _domAttrList.push({
                        name: name,
                        content:content
                    });
                    return 'bg-' + findAttr;
                });
                return find;
            });
            console.log(s);
            console.log('domAttrReg', _domAttrList);

            //var tmpl2 = document.getElementById('tmpl2').innerHTML;
            //_domAttrReg = /\s*(\S+)\s*=\s*(\"(?:\\\"|[^"])*?\[.*?\](?:\\\"|[^"])*\"|\'(?:\\\'|[^'])*?\[.*?\](?:\\\'|[^'])*\')/gi;
            //console.log(_domAttrReg.exec(tmpl2));

            //console.log('tmpl ===> ', (regEx.exec(tmpl)));

        })();

        //render-->comp-->create-->ctrl-->layout-->ready
        //render-->comp-->create-->子comp-->子create-->ctrl-->layout-->子ctrl-->子layout-->ready
        //cp <---> view

        //todo: comp
        (function () {
            return;

            var view = {
                //拥有的节点
                _bgNode: null,
                name: ''
            };

            var compItem = {
                name: '',
                //拥有的节点
                _bgNode: null,
                view: view,
                children: [],
                //编译前的nodes, 包括cmd节点
                _bgNodes: [],
                //编译后的nodes
                nodes: [],
                command: null,
                content: '',
                attrs: function () {
                    if (this._bgOldCtn != this.content) {
                        this._bgOldCtn = this.content;
                        this._bgAttrs = tranAtrr;//分析
                    }
                    return this._bgAttrs;
                },
                value: function () { },
                result: function () {
                },
                eval: function () {
                },
                render: function () {
                },
                observe: function () {
                },
                layout: function () {
                }
            };

            bingo.command('name', function (cp, attrs) {

                return cp.render(function (context) {
                    return context;
                    return bingo.tmpl(url);
                }).layout(function (c) {
                    return '';
                });

            });

        })();

        //todo: route
        (function () {
            return;
            var app = bingo.app('demo');

            //设置tmpl资源路由
            app.route('tmpl', {
                type:'tmpl',
                //路由url, 如: view/system/user/list
                url: '{tmpl*}',
                //路由到目标url, 生成:modules/system/user/list.html
                to: '{tmpl*}.html',
                //变量默认值, 框架提供内部用的变量: app, controller, component, service
                defaultValue: { app: 'demo', tmpl: '' }
            });

            //设置actionS资源路由
            app.route('ctrl', {
                type: 'controller',
                url: 'ctrl/{controller*}',
                to: '{controller*}.js',
                defaultValue: { controller: '' }
            });

            //设置component资源路由
            app.route('component', {
                type: 'component',
                url: 'comp/{component*}',
                to: 'comps/{component*}.js',
                defaultValue: { component: '' }
            });

            //设置service资源路由
            app.route('service', {
                type: 'service',
                url: '{service*}',
                to: '{service*}.js',
                defaultValue: { service: '' }
            });


        })();
    </script>
</body>
</html>
